<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부원 신청</title>
    <style>
        .response-message {
            color: green;
            margin-top: 5px;
        }
        .error-message {
            color: red;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<h1>부원 신청</h1>
<hr>
<form id="signUpForm" action="/signup" method="post">
    <input id="name" type="text" name="name" placeholder="이름"><br>
    <input id="studentnumber" type="text" name="studentnumber" placeholder="학번"><br>
    <button type="button" onclick="checkStudentNumber()">중복 확인</button>
    <div id="studentnumber-response"></div>
    <input id="password" type="password" name="password" placeholder="비밀번호" required><br>
    <input id="confirm_password" type="password" name="confirm_password" placeholder="비밀번호 확인" required><br>
    <input id="college" type="text" name="college" placeholder="단과대학"><br>
    <input id="department" type="text" name="department" placeholder="학과"><br>
    <input id="isregistered" type="checkbox" name="isregistered" checked>
    <label for="isregistered">재학중</label><br>
    <input id="grade" type="text" name="grade" placeholder="학년"><br>
    <input id="phonenumber" type="text" name="phonenumber" placeholder="전화번호"><br>
    <input type="submit" value="가입">
</form>
<script>
    var isStudentNumberValid = false; // 학번 중복 검사의 유효성을 추적하는 변수

    function checkPasswords() {
        var password = document.getElementById('password').value;
        var confirmPassword = document.getElementById('confirm_password').value;

        // 비밀번호가 일치하지 않으면 사용자에게 알림
        if (password !== confirmPassword) {
            alert('입력한 두 비밀번호가 일치하지 않습니다.');
            return false; // 폼 제출을 막음
        }

        return true; // 폼 제출 계속
    }

    function checkStudentNumber() {
        const studentNumberInput = document.querySelector("#studentnumber");
        const studentNumber = studentNumberInput.value;
        const responseElement = document.querySelector("#studentnumber-response");

        if (!studentNumber) {
            responseElement.innerHTML = '<p class="error-message">학번을 입력해주세요.</p>';
            isStudentNumberValid = false; // 학번 검사 실패
            return;
        }

        fetch('/check/id', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ studentnumber: studentNumber })
        })
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        isStudentNumberValid = true; // 학번 사용 가능
                        responseElement.innerHTML = '<p class="response-message">사용할 수 있는 학번입니다.</p>';
                    } else {
                        isStudentNumberValid = false; // 학번 사용 불가
                        responseElement.innerHTML = '<p class="error-message">이미 사용 중인 학번입니다.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    responseElement.innerHTML = '<p class="error-message">에러가 발생했습니다. 다시 시도해주세요.</p>';
                    isStudentNumberValid = false; // 에러 발생 시
                });
    }

    function validateForm() {
        // 모든 필드가 입력되었는지 확인
        var name = document.getElementById('name').value;
        var studentNumber = document.getElementById('studentnumber').value;
        var password = document.getElementById('password').value;
        var confirmPassword = document.getElementById('confirm_password').value;
        var college = document.getElementById('college').value;
        var department = document.getElementById('department').value;
        var grade = document.getElementById('grade').value;
        var phoneNumber = document.getElementById('phonenumber').value;

        if (!name || !studentNumber || !password || !confirmPassword || !college || !department || !grade || !phoneNumber) {
            alert('모든 필드를 입력해주세요.');
            return false;
        }

        // 비밀번호 일치 및 학번 중복 검사 확인
        if (!checkPasswords() || !isStudentNumberValid) {
            if (!isStudentNumberValid) {
                alert('학번 중복 검사를 완료해주세요.');
            }
            return false;
        }

        return true; // 모든 검사 통과
    }

    document.getElementById('signUpForm').onsubmit = function() {
        return validateForm(); // 폼 제출 전 유효성 검사 실행
    };
</script>

</body>
</html>
